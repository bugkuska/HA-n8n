# =========================================================
# configuration.yaml (FULL - Stable entity_id)
# =========================================================

# Loads default set of integrations. Do not remove.
default_config:

# Load frontend themes from the themes folder
frontend:
  themes: !include_dir_merge_named themes

automation: !include automations.yaml
script: !include scripts.yaml
scene: !include scenes.yaml


# =========================================================
# Customize (UI แต่ entity_id คงเดิม)
# =========================================================
homeassistant:
  customize:
    sensor.pzem016_power_meter:
      friendly_name: "PZEM016 Power Meter"
      icon: mdi:flash

    sensor.monthly_energy_display:
      friendly_name: "Monthly Energy (Display)"
      icon: mdi:calendar-month

    sensor.monthly_energy_pea_display:
      friendly_name: "Monthly Energy PEA (Display)"
      icon: mdi:calendar-sync

    sensor.pea_billing_period:
      friendly_name: "PEA Billing Period"
      icon: mdi:calendar-range

    sensor.pea_billing_period_th:
      friendly_name: "PEA Billing Period (TH)"
      icon: mdi:calendar-range

    sensor.cost_150:
      friendly_name: "ค่าไฟ 150 หน่วยแรก"
      icon: mdi:cash-100

    sensor.cost_250:
      friendly_name: "ค่าไฟหน่วยที่ 151–400"
      icon: mdi:cash-100

    sensor.cost_400:
      friendly_name: "ค่าไฟหน่วยที่ 400 ขึ้นไป"
      icon: mdi:cash-100

    sensor.base_cost:
      friendly_name: "ค่าไฟฐาน (ตามขั้นหน่วย)"
      icon: mdi:cash

    sensor.base_cost_services_charge:
      friendly_name: "ค่าไฟฐาน (รวมค่าบริการ)"
      icon: mdi:cash-plus

    sensor.ft_cost:
      friendly_name: "ค่า FT"
      icon: mdi:flash-outline

    sensor.sub_total_before_vat:
      friendly_name: "รวมก่อน VAT (ฐาน+บริการ+FT)"
      icon: mdi:cash-plus

    sensor.vat_7_percent:
      friendly_name: "VAT 7%"
      icon: mdi:percent

    sensor.total_cost:
      friendly_name: "รวมสุทธิ (Total) รอบบิล PEA"
      icon: mdi:cash-check


# =========================================================
# Modern Template Sensors (ค่าไฟ) - entity_id มาจาก name
# =========================================================
template:
  - sensor:

      - name: "monthly_energy_pea_display"
        unique_id: monthly_energy_pea_display
        unit_of_measurement: "kWh"
        device_class: energy
        state_class: measurement
        state: "{{ states('sensor.monthly_energy_pea') | float(0) | round(3) }}"

      - name: "PEA Billing Period (TH)"
        unique_id: pea_billing_period_th
        icon: mdi:calendar-range
        state: >
          {% set t = now() %}
          {% if t.day >= 16 %}
            {% set start = t.replace(day=16) %}
            {% set end = (t.replace(day=1) + timedelta(days=32)).replace(day=15) %}
          {% else %}
            {% set start = (t.replace(day=1) - timedelta(days=1)).replace(day=16) %}
            {% set end = t.replace(day=15) %}
          {% endif %}
          {% set th = ['ม.ค.','ก.พ.','มี.ค.','เม.ย.','พ.ค.','มิ.ย.','ก.ค.','ส.ค.','ก.ย.','ต.ค.','พ.ย.','ธ.ค.'] %}
          {{ start.day }} {{ th[start.month-1] }} {{ start.year+543 }} – {{ end.day }} {{ th[end.month-1] }} {{ end.year+543 }}

          
      - name: "PEA Cost 0-150"
        unique_id: pea_cost_0_150_v1
        unit_of_measurement: "THB"
        icon: mdi:cash-100
        state: >
          {% set unit = states('sensor.monthly_energy_pea') | float(0) %}
          {% set price = 3.2484 %}
          {% set u = [unit, 150] | min %}
          {{ (u * price) | round(2) }}

      - name: "PEA Cost 151-400"
        unique_id: pea_cost_151_400_v1
        unit_of_measurement: "THB"
        icon: mdi:cash-100
        state: >
          {% set unit = states('sensor.monthly_energy_pea') | float(0) %}
          {% set price = 4.2218 %}
          {% set u = [ [unit - 150, 0] | max, 250 ] | min %}
          {{ (u * price) | round(2) }}

      - name: "PEA Cost 400+"
        unique_id: pea_cost_400_plus_v1
        unit_of_measurement: "THB"
        icon: mdi:cash-100
        state: >
          {% set unit = states('sensor.monthly_energy_pea') | float(0) %}
          {% set price = 4.4217 %}
          {% set u = [unit - 400, 0] | max %}
          {{ (u * price) | round(2) }}

      - name: "PEA Base Cost"
        unique_id: pea_base_cost_v1
        unit_of_measurement: "THB"
        icon: mdi:cash
        state: >
          {% set c150 = states('sensor.pea_cost_0_150') | float(0) %}
          {% set c2   = states('sensor.pea_cost_151_400') | float(0) %}
          {% set c3   = states('sensor.pea_cost_400_plus') | float(0) %}
          {{ (c150 + c2 + c3) | round(2) }}

      - name: "PEA Base+Service"
        unique_id: pea_base_service_v1
        unit_of_measurement: "THB"
        icon: mdi:cash-plus
        state: >
          {% set base = states('sensor.pea_base_cost') | float(0) %}
          {% set svc  = states('input_number.servicecharge') | float(0) %}
          {{ (base + svc) | round(2) }}

      - name: "PEA FT Cost"
        unique_id: pea_ft_cost_v1
        unit_of_measurement: "THB"
        icon: mdi:flash-outline
        state: >
          {% set unit = states('sensor.monthly_energy_pea') | float(0) %}
          {% set ft   = states('input_number.ftcharge') | float(0) %}
          {{ (unit * ft) | round(2) }}

      - name: "PEA Subtotal Before VAT"
        unique_id: pea_subtotal_v1
        unit_of_measurement: "THB"
        icon: mdi:cash-plus
        state: >
          {% set base_svc = states('sensor.pea_base_service') | float(0) %}
          {% set ftc      = states('sensor.pea_ft_cost') | float(0) %}
          {{ (base_svc + ftc) | round(2) }}

      - name: "PEA VAT 7%"
        unique_id: pea_vat7_v1
        unit_of_measurement: "THB"
        icon: mdi:percent
        state: >
          {% set sub = states('sensor.pea_subtotal_before_vat') | float(0) %}
          {{ (sub * 0.07) | round(2) }}

      - name: "PEA Total Cost"
        unique_id: pea_total_v1
        unit_of_measurement: "THB"
        icon: mdi:cash-check
        state: >
          {% set sub = states('sensor.pea_subtotal_before_vat') | float(0) %}
          {% set vat = states('sensor.pea_vat_7') | float(0) %}
          {{ (sub + vat) | round(2) }}

# =========================================================
# Utility Meter
# - monthly_energy         = รอบปฏิทิน
# - monthly_energy_pea     = รอบบิล PEA (offset 15 = เริ่มนับวันที่ 16)
# =========================================================
utility_meter:
  daily_energy:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: daily
    offset:
      hours: 0
      minutes: 0

  monthly_energy:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: monthly
    offset:
      days: 0
      hours: 0
      minutes: 0

  monthly_energy_pea:
    source: sensor.esp32_pzem016_powermon_total_daily_energy
    cycle: monthly
    offset:
      days: 15
      hours: 0
      minutes: 0


# =========================================================
# Input Number
# =========================================================
input_number:
  servicecharge:
    name: Service Charge
    icon: mdi:cash-100
    min: 0
    max: 100
    step: 0.01
    mode: box

  ftcharge:
    name: FT Charge
    icon: mdi:flash
    min: 0
    max: 10
    step: 0.0001
    mode: box

  pea_prev_bill_kwh:
    name: PEA Previous Bill kWh
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box

  pea_prev_bill_total:
    name: PEA Previous Bill Total
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box

  # ---------- kWh history ----------
  pea_bill_kwh_1:
    name: PEA Bill kWh (1) ล่าสุด
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box
  pea_bill_kwh_2:
    name: PEA Bill kWh (2)
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box
  pea_bill_kwh_3:
    name: PEA Bill kWh (3)
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box
  pea_bill_kwh_4:
    name: PEA Bill kWh (4)
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box
  pea_bill_kwh_5:
    name: PEA Bill kWh (5)
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box
  pea_bill_kwh_6:
    name: PEA Bill kWh (6) เก่าสุด
    icon: mdi:counter
    min: 0
    max: 999999
    step: 0.0001
    mode: box

  # ---------- Total THB history ----------
  pea_bill_total_1:
    name: PEA Bill Total (1) ล่าสุด
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box
  pea_bill_total_2:
    name: PEA Bill Total (2)
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box
  pea_bill_total_3:
    name: PEA Bill Total (3)
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box
  pea_bill_total_4:
    name: PEA Bill Total (4)
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box
  pea_bill_total_5:
    name: PEA Bill Total (5)
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box
  pea_bill_total_6:
    name: PEA Bill Total (6) เก่าสุด
    icon: mdi:cash-check
    min: 0
    max: 999999
    step: 0.01
    mode: box
