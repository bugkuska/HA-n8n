{
  "name": "Flow1-Raw-log5min-Flow2-Daily Update PEA Cycle Summary",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ha-pzem016-raw-5m",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -752,
        -544
      ],
      "id": "9e0d287e-08be-4350-8f48-84fa9feebe68",
      "name": "Webhook",
      "webhookId": "596bfe95-3c49-4b5a-8b6d-ac90c4aaebc2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d771b20e-f16a-4dae-80e2-62771b1bbe8b",
              "name": "ts_5m",
              "value": "={{ (() => {\n  const d = new Date($json.body.timestamp);\n  d.setSeconds(0,0);\n  d.setMinutes(Math.floor(d.getMinutes()/5)*5);\n  return d.toISOString();\n})() }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -528,
        -544
      ],
      "id": "9a45be67-89d3-4d01-a827-a07c424ea798",
      "name": "SET | Build ts_5m"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "d771b20e-f16a-4dae-80e2-62771b1bbe8b",
              "name": "row_key",
              "value": "={{ $json.body.site + '_' + $json.body.device + '_' + $json.body.ts_5m }}",
              "type": "string"
            },
            {
              "id": "9fb88a0e-370b-4e08-a671-36f1961b9544",
              "name": "cycle_key",
              "value": "={{ \n  $node[\"Webhook\"].json.body.site \n  + \"|\" + \n  $node[\"Webhook\"].json.body.device \n  + \"|\" + \n  $node[\"SET | Build ts_5m\"].json.ts_5m.slice(0,7) \n}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -304,
        -480
      ],
      "id": "3b209af6-01d6-4264-ae45-0354148c18ca",
      "name": "SET | Build row_key + cycle_key",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "214cf1c9-1da6-4ac4-8b5c-71223ee2dfa2",
              "name": "message",
              "value": "duplicate skipped",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        816,
        -432
      ],
      "id": "46f2a957-278a-4cb6-b033-4819691bbd61",
      "name": "LOG | RAW Duplicate - Skipped"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "energy_raw_5m",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ts": "={{$node[\"Webhook\"].json.body.timestamp}}",
            "site": "={{$node[\"Webhook\"].json.body.site}}",
            "device": "={{$node[\"Webhook\"].json.body.device}}",
            "billing_period": "={{$node[\"Webhook\"].json.body.billing_period}}",
            "kwh_cycle": "={{$node[\"Webhook\"].json.body.kwh_cycle}}",
            "voltage_v": "={{$node[\"Webhook\"].json.body.voltage_v}}",
            "current_a": "={{$node[\"Webhook\"].json.body.current_a}}",
            "power_w": "={{$node[\"Webhook\"].json.body.power_w}}",
            "frequency_hz": "={{$node[\"Webhook\"].json.body.frequency_hz}}",
            "power_factor": "={{$node[\"Webhook\"].json.body.power_factor}}",
            "kwh_today": "={{$node[\"Webhook\"].json.body.kwh_today}}",
            "row_key": "={{ $node[\"SET | Build row_key + cycle_key\"].json.row_key }}",
            "ts_5m": "={{ $node[\"SET | Build ts_5m\"].json.ts_5m }}",
            "cycle_key": "={{ $node[\"SET | Build row_key + cycle_key\"].json.cycle_key }}",
            "base_cost": "={{ $node[\"Webhook\"].json.body.base_cost }}",
            "service_charge": "={{ $node[\"Webhook\"].json.body.service_charge }}",
            "ft_rate": "={{ $node[\"Webhook\"].json.body.ft_rate }}",
            "ft_cost": "={{ $node[\"Webhook\"].json.body.ft_cost }}",
            "subtotal_before_vat": "={{ $node[\"Webhook\"].json.body.subtotal_before_vat }}",
            "vat_7_percent": "={{ $node[\"Webhook\"].json.body.vat_7_percent }}",
            "total_cost": "={{ $node[\"Webhook\"].json.body.total_cost }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ts",
              "displayName": "ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "site",
              "displayName": "site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "device",
              "displayName": "device",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "billing_period",
              "displayName": "billing_period",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "kwh_cycle",
              "displayName": "kwh_cycle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voltage_v",
              "displayName": "voltage_v",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_a",
              "displayName": "current_a",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "power_w",
              "displayName": "power_w",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "frequency_hz",
              "displayName": "frequency_hz",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "power_factor",
              "displayName": "power_factor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "kwh_today",
              "displayName": "kwh_today",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_key",
              "displayName": "row_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ts_5m",
              "displayName": "ts_5m",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cycle_key",
              "displayName": "cycle_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "base_cost",
              "displayName": "base_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_charge",
              "displayName": "service_charge",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_rate",
              "displayName": "ft_rate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_cost",
              "displayName": "ft_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "subtotal_before_vat",
              "displayName": "subtotal_before_vat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "vat_7_percent",
              "displayName": "vat_7_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_cost",
              "displayName": "total_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        544,
        -736
      ],
      "id": "63aeab04-a7dd-4c44-a1a8-dfa4862d6ed9",
      "name": "GS | Append Energy RAW (5m)",
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "triggerTimes": {
          "item": [
            {
              "hour": 0
            }
          ]
        }
      },
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        -768,
        -16
      ],
      "id": "a3cc60ea-9f91-488e-9721-9d125b9a78da",
      "name": "CRON | Daily 00:00"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "77e20b42-38af-4fab-b61f-be0cf75389b0",
              "name": "ts_midnight",
              "value": "={{ DateTime.now().setZone('Asia/Bangkok').startOf('day').toISO() }}",
              "type": "string"
            },
            {
              "id": "39cd4802-63f7-4aac-98e4-92aa6d1c625c",
              "name": "cycle_key",
              "value": "={{ \"MSUSmartFarm|PZEM016|\" + DateTime.now().setZone('Asia/Bangkok').toFormat('yyyy-MM') }}",
              "type": "string"
            },
            {
              "id": "f0a6dfa5-b941-47fe-9404-62cf5ea92972",
              "name": "snapshot_ts",
              "value": "={{ DateTime.now().setZone('Asia/Bangkok').startOf('day').toISO() }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -544,
        -16
      ],
      "id": "396dcf6f-841d-4098-b47b-46c88f91dc62",
      "name": "SET | Build midnight row_key + cycle_key"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "energy_raw_5m",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "cycle_key",
              "lookupValue": "={{ $json.cycle_key }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -320,
        -16
      ],
      "id": "d59a057a-1dfb-4152-a3c1-6fd41f643bfb",
      "name": "GS | Lookup RAW @00:00",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "6fbe59a3-ad73-4f8e-b43c-8f1589f72fa2",
              "leftValue": "={{ Object.keys($json || {}).length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        128,
        -16
      ],
      "id": "6589a278-b04b-42bf-8188-75f63fb203ef",
      "name": "IF | RAW Found?"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "214cf1c9-1da6-4ac4-8b5c-71223ee2dfa2",
              "name": "message",
              "value": "no raw at midnight",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        352,
        80
      ],
      "id": "b21d94ee-b36b-40e5-a500-7570fbdcfac5",
      "name": "LOG | No RAW at midnight - Skipped"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "36f659b7-4ef4-49ee-9eb5-ac0c842d5faf",
              "name": "billing_period",
              "value": "={{ $json.billing_period || \"\" }}",
              "type": "string"
            },
            {
              "id": "92c69781-7566-49dd-9c3d-9eca08aa18a5",
              "name": "last_update_ts",
              "value": "={{ $node[\"SET | Build midnight row_key + cycle_key\"].json.ts_midnight }}",
              "type": "string"
            },
            {
              "id": "f31fd199-0287-4724-9b06-1b4a83029073",
              "name": "site",
              "value": "={{ $json.site || \"\" }}",
              "type": "string"
            },
            {
              "id": "52444298-72ac-4622-951d-980ece859405",
              "name": "device",
              "value": "={{ $json.device || \"\" }}",
              "type": "string"
            },
            {
              "id": "3a27a771-5206-467d-9f85-56c6893bc996",
              "name": "kwh_cycle",
              "value": "={{ $json.kwh_cycle || 0 }} ",
              "type": "string"
            },
            {
              "id": "2fc166ad-df8e-4de1-b490-39929cb6d794",
              "name": "base_cost",
              "value": "={{ $json.base_cost || 0 }} ",
              "type": "string"
            },
            {
              "id": "d1fe8794-560f-4acd-a495-980d34215d81",
              "name": "service_charge",
              "value": "={{ $json.service_charge || 0 }} ",
              "type": "string"
            },
            {
              "id": "29a1ea3a-06ff-408a-a255-648967a679d0",
              "name": "ft_rate",
              "value": "={{ $json.ft_rate || 0 }} ",
              "type": "string"
            },
            {
              "id": "4c125016-eacd-4a33-8ef5-68e1f2e5b314",
              "name": "ft_cost",
              "value": "={{ $json.ft_cost || 0 }} ",
              "type": "string"
            },
            {
              "id": "38933773-74a9-4009-b8a8-5d64ea7eb5a8",
              "name": "subtotal_before_vat",
              "value": "={{ $json.subtotal_before_vat || 0 }} ",
              "type": "string"
            },
            {
              "id": "9e972da4-3018-49da-8bf5-1533221f6ab8",
              "name": "vat_7_percent",
              "value": "={{ $json.vat_7_percent || 0 }}",
              "type": "string"
            },
            {
              "id": "99b1ffdf-bfc2-4adc-8244-5efa8c23dda5",
              "name": "total_cost",
              "value": "={{ $json.total_cost || 0 }}",
              "type": "string"
            },
            {
              "id": "4a74f014-eb33-467e-a815-394d0fdab365",
              "name": "cycle_key",
              "value": "={{ $json.cycle_key || $node[\"SET | Build midnight row_key + cycle_key\"].json.cycle_key }}",
              "type": "string"
            },
            {
              "id": "16078aba-3336-4e12-b9cd-c56e578d5069",
              "name": "snapshot_ts",
              "value": "={{ $node[\"SET | Build midnight row_key + cycle_key\"].json.ts_midnight }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        352,
        -112
      ],
      "id": "a62b1b44-e512-438d-86b8-c75ad30d277b",
      "name": "SET | Build Cycle Summary Payload"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 919573753,
          "mode": "list",
          "cachedResultName": "pea_cycle_summary",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=919573753"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "cycle_key",
              "lookupValue": "={{ $json.cycle_key }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        576,
        -112
      ],
      "id": "72d30faf-76a2-42c8-80b2-f731e2ec7b03",
      "name": "GS | Find Cycle Row",
      "alwaysOutputData": true,
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3af957ce-8918-4946-8bad-260d02081f8f",
              "leftValue": "={{ $json.cycle_exists }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        1024,
        -112
      ],
      "id": "c4e6d2e1-3d50-4437-8566-364f68b67f39",
      "name": "IF | Cycle Exists?",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 919573753,
          "mode": "list",
          "cachedResultName": "pea_cycle_summary",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=919573753"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "cycle_key": "={{ $json.cycle_key }}",
            "billing_period": "={{ $json.billing_period }}",
            "last_update_ts": "={{ $json.last_update_ts }}",
            "site": "={{ $json.site }}",
            "device": "={{ $json.device }}",
            "kwh_cycle": "={{ $json.kwh_cycle }}",
            "base_cost": "={{ $json.base_cost }}",
            "service_charge": "={{ $json.service_charge }}",
            "ft_rate": "={{ $json.ft_rate }}",
            "ft_cost": "={{ $json.ft_cost }}",
            "subtotal_before_vat": "={{ $json.subtotal_before_vat }}",
            "vat_7_percent": "={{ $json.vat_7_percent }}",
            "total_cost": "={{ $json.total_cost }}",
            "row_number": "={{ Number($json.row_number) }}",
            "snapshot_ts": "={{ $json.snapshot_ts }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "billing_period",
              "displayName": "billing_period",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "snapshot_ts",
              "displayName": "snapshot_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_update_ts",
              "displayName": "last_update_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "site",
              "displayName": "site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "device",
              "displayName": "device",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "kwh_cycle",
              "displayName": "kwh_cycle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "base_cost",
              "displayName": "base_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_charge",
              "displayName": "service_charge",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_rate",
              "displayName": "ft_rate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_cost",
              "displayName": "ft_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "subtotal_before_vat",
              "displayName": "subtotal_before_vat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "vat_7_percent",
              "displayName": "vat_7_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_cost",
              "displayName": "total_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cycle_key",
              "displayName": "cycle_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1248,
        -208
      ],
      "id": "1b12b171-f824-4cf6-be95-76267a7e0069",
      "name": "GS | Update Cycle Summary",
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 919573753,
          "mode": "list",
          "cachedResultName": "pea_cycle_summary",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=919573753"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "billing_period": "={{ $json.billing_period }}",
            "last_update_ts": "={{ $json.last_update_ts }}",
            "device": "={{ $json.device }}",
            "kwh_cycle": "={{ $json.kwh_cycle }}",
            "service_charge": "={{ $json.service_charge }}",
            "subtotal_before_vat": "={{ $json.subtotal_before_vat }}",
            "vat_7_percent": "={{ $json.vat_7_percent }}",
            "site": "={{ $json.site }}",
            "ft_rate": "={{ $json.ft_rate }}",
            "ft_cost": "={{ $json.ft_cost }}",
            "total_cost": "={{ $json.total_cost }}",
            "base_cost": "={{ $json.base_cost }}",
            "cycle_key": "={{ $json.cycle_key }}",
            "snapshot_ts": "={{ $json.snapshot_ts }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "billing_period",
              "displayName": "billing_period",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "snapshot_ts",
              "displayName": "snapshot_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "last_update_ts",
              "displayName": "last_update_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "site",
              "displayName": "site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "device",
              "displayName": "device",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "kwh_cycle",
              "displayName": "kwh_cycle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "base_cost",
              "displayName": "base_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_charge",
              "displayName": "service_charge",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_rate",
              "displayName": "ft_rate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_cost",
              "displayName": "ft_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "subtotal_before_vat",
              "displayName": "subtotal_before_vat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "vat_7_percent",
              "displayName": "vat_7_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_cost",
              "displayName": "total_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cycle_key",
              "displayName": "cycle_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1248,
        -16
      ],
      "id": "2df77e06-7522-49e9-8dd8-d03243a02bf1",
      "name": "GS | Append Cycle Summary",
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nitems.sort((a,b) => (b.json.ts||'').localeCompare(a.json.ts||''));\nreturn items.slice(0,1);\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        -16
      ],
      "id": "93f93ea3-fa0c-4fec-a453-299885956037",
      "name": "CODE | Select Latest RAW"
    },
    {
      "parameters": {
        "jsCode": "// CODE | Merge Find + Payload (FIXED - payload wins)\n// Purpose:\n// - Merge payload (from \"SET | Build Cycle Summary Payload\") with lookup result\n//   (from \"GS | Find Cycle Row\") that may be empty.\n// - Always output a single item with full payload fields.\n// - Add cycle_exists boolean.\n// - If cycle exists, attach row_number as a NUMBER (optional; useful if Update by row_number).\n\nconst payload = $node[\"SET | Build Cycle Summary Payload\"]?.json || {};\nconst found = $json || {}; // input from \"GS | Find Cycle Row\" (may be empty)\n\n// Detect whether the cycle row exists in summary sheet\nconst cycleExists = Object.keys(found || {}).length > 0;\n\n// Try to get row number from possible keys returned by Google Sheets node\nconst rawRowNumber =\n  found.row_number ??\n  found.rowNumber ??\n  found.rowIndex ??\n  null;\n\n// Build merged object\n// IMPORTANT: payload MUST win (so updated timestamps & values are not overwritten by old sheet values)\nconst merged = {\n  ...found,\n  ...payload,\n  cycle_exists: cycleExists,\n};\n\n// If exists, ensure row_number is a real number (only if you still use it somewhere)\nif (cycleExists && rawRowNumber !== null && rawRowNumber !== undefined && rawRowNumber !== \"\") {\n  merged.row_number = Number(rawRowNumber);\n}\n\n// Strongly enforce key fields from payload (prevents old values from found overriding)\nif (payload.cycle_key) merged.cycle_key = payload.cycle_key;\nif (payload.snapshot_ts) merged.snapshot_ts = payload.snapshot_ts;\nif (payload.last_update_ts) merged.last_update_ts = payload.last_update_ts;\n\n// Safety fallbacks (only when payload is missing them)\nconst midnightNode = $node[\"SET | Build midnight row_key + cycle_key\"]?.json || {};\nif (!merged.cycle_key && midnightNode.cycle_key) merged.cycle_key = midnightNode.cycle_key;\n\n// NOTE: Do NOT fallback last_update_ts to ts_midnight unless you truly want it to be 00:00.\n// If you want \"run time\" timestamps, payload.last_update_ts should always be present.\n// Keep this fallback only as a safety net:\nif (!merged.last_update_ts && payload.last_update_ts == null && midnightNode.ts_midnight) {\n  merged.last_update_ts = midnightNode.ts_midnight;\n}\n\nreturn [{ json: merged }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        -112
      ],
      "id": "9decff6a-d7d1-43ad-9dbc-c008870cefe1",
      "name": "CODE | Merge Find + Payload"
    },
    {
      "parameters": {
        "content": "## ðŸ”  Flow 1 : RAW Logger (à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸¸à¸ 5 à¸™à¸²à¸—à¸µ à¹à¸¥à¸°à¸•à¸²à¸¡à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹à¸›à¸¥à¸‡à¸‚à¸­à¸‡ Power (W))",
        "height": 528,
        "width": 1968,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -848,
        -784
      ],
      "typeVersion": 1,
      "id": "7bf68b2f-8516-4ca3-ba4f-d3939ba36df6",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "content": "## ðŸŒ™ Flow 2 : Daily Cycle Builder (à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸£à¸¸à¸›à¸£à¸²à¸¢à¸§à¸±à¸™ / à¸£à¸­à¸šà¸šà¸´à¸¥)",
        "height": 496,
        "width": 2320,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -848,
        -240
      ],
      "typeVersion": 1,
      "id": "f4f35a8f-d2d5-4120-9bd1-ab5ac4917087",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "energy_raw_5m",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "device",
              "lookupValue": "={{$json.body.device}}"
            },
            {
              "lookupColumn": "site",
              "lookupValue": "={{$json.body.site}}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -64,
        -480
      ],
      "id": "007a818f-0db0-4b90-986e-909ece053be4",
      "name": "GS | Find Last Power",
      "alwaysOutputData": true,
      "retryOnFail": false,
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rows = $input.all().map(i => i.json);\n\nif (!rows.length) {\n  return [{ json: { ts: 0, power_w: 0 } }];\n}\n\n// à¹€à¸£à¸µà¸¢à¸‡à¸ˆà¸²à¸ ts à¹ƒà¸«à¸¡à¹ˆà¸ªà¸¸à¸” -> à¹€à¸à¹ˆà¸²à¸ªà¸¸à¸”\nrows.sort((a, b) => new Date(b.ts).getTime() - new Date(a.ts).getTime());\n\n// à¸ªà¹ˆà¸‡à¸à¸¥à¸±à¸šà¹à¸–à¸§à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸£à¸´à¸‡ 1 à¹à¸–à¸§\nreturn [{ json: rows[0] }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        128,
        -544
      ],
      "id": "dbacdaf2-25f6-41f8-91cc-1e3295d0e776",
      "name": "CODE | Pick Latest Power"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "8ce641e4-cac9-4b06-ae03-50e186ca7602",
              "leftValue": "={{\n  Math.abs(\n    Number($node[\"Webhook\"].json.body.power_w || 0) -\n    Number($items(\"CODE | Pick Latest Power\")[0].json.power_w || 0)\n  )\n}}",
              "rightValue": "={{\n  (() => {\n    const p = Number($node[\"Webhook\"].json.body.power_w) || 0;\n\n    // à¹ƒà¸Šà¹‰ timestamp à¸ˆà¸²à¸ HA\n    const ts = $node[\"Webhook\"].json.body.timestamp;\n    const hour = new Date(ts).getHours();\n    const isNight = (hour >= 22 || hour < 6);\n\n    // à¸à¸¥à¸²à¸‡à¸„à¸·à¸™: 5 / 10 / 50\n    if (isNight) {\n      if (p < 200) return 5;\n      if (p < 1000) return 10;\n      return 50;\n    }\n\n    // à¸à¸¥à¸²à¸‡à¸§à¸±à¸™: 10 / 20 / 100\n    if (p < 200) return 10;\n    if (p < 1000) return 20;\n    return 100;\n  })()\n}}",
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        336,
        -544
      ],
      "id": "bdce3f45-1c52-47ea-b8d7-b90e604b9609",
      "name": "IF | Power Changed?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "f20f1150-94f6-45c5-8288-c7a8130f66e8",
              "leftValue": "={{ Math.floor(new Date($node[\"Webhook\"].json.body.timestamp).getTime() / 300000) }}",
              "rightValue": "={{ Math.floor(new Date($items(\"CODE | Pick Latest Power\")[0].json.ts).getTime() / 300000) }}",
              "operator": {
                "type": "number",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        544,
        -448
      ],
      "id": "b50f9843-daa9-4101-a746-6092043a2c86",
      "name": "IF | New 5m Bucket?"
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "energy_raw_5m",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{$items(\"CODE | Pick Latest Power\")[0].json.row_number}}",
            "ts": "={{$node[\"Webhook\"].json.body.timestamp}}",
            "voltage_v": "={{$node[\"Webhook\"].json.body.voltage_v}}",
            "current_a": "={{$node[\"Webhook\"].json.body.current_a}}",
            "power_w": "={{$node[\"Webhook\"].json.body.power_w}}",
            "ts_5m": "={{$node[\"SET | Build ts_5m\"].json.ts_5m}}",
            "row_key": "={{$node[\"SET | Build row_key + cycle_key\"].json.row_key}}",
            "site": "={{$node[\"Webhook\"].json.body.site}}",
            "device": "={{$node[\"Webhook\"].json.body.device}}",
            "billing_period": "={{$node[\"Webhook\"].json.body.billing_period}}",
            "kwh_cycle": "={{$node[\"Webhook\"].json.body.kwh_cycle}}",
            "frequency_hz": "={{$node[\"Webhook\"].json.body.frequency_hz}}",
            "power_factor": "={{$node[\"Webhook\"].json.body.power_factor}}",
            "kwh_today": "={{$node[\"Webhook\"].json.body.kwh_today}}",
            "cycle_key": "={{$node[\"SET | Build row_key + cycle_key\"].json.cycle_key}}",
            "base_cost": "={{$node[\"Webhook\"].json.body.base_cost}}",
            "service_charge": "={{$node[\"Webhook\"].json.body.service_charge}}",
            "ft_rate": "={{$node[\"Webhook\"].json.body.ft_rate}}",
            "ft_cost": "={{$node[\"Webhook\"].json.body.ft_cost}}",
            "subtotal_before_vat": "={{$node[\"Webhook\"].json.body.subtotal_before_vat}}",
            "vat_7_percent": "={{$node[\"Webhook\"].json.body.vat_7_percent}}",
            "total_cost": "={{$node[\"Webhook\"].json.body.total_cost}}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "ts",
              "displayName": "ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "site",
              "displayName": "site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "device",
              "displayName": "device",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "billing_period",
              "displayName": "billing_period",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "kwh_cycle",
              "displayName": "kwh_cycle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voltage_v",
              "displayName": "voltage_v",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_a",
              "displayName": "current_a",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "power_w",
              "displayName": "power_w",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "frequency_hz",
              "displayName": "frequency_hz",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "power_factor",
              "displayName": "power_factor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "kwh_today",
              "displayName": "kwh_today",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_key",
              "displayName": "row_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ts_5m",
              "displayName": "ts_5m",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "cycle_key",
              "displayName": "cycle_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "base_cost",
              "displayName": "base_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "service_charge",
              "displayName": "service_charge",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ft_rate",
              "displayName": "ft_rate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "ft_cost",
              "displayName": "ft_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "subtotal_before_vat",
              "displayName": "subtotal_before_vat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "vat_7_percent",
              "displayName": "vat_7_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "total_cost",
              "displayName": "total_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        800,
        -640
      ],
      "id": "3f475f65-46b8-4af1-8c96-ab6ffdeaf569",
      "name": "GS | Update Latest Row",
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY",
          "mode": "list",
          "cachedResultName": "power_meter_logger",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "energy_raw_5m",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1EU2z4oDA9TtLifjMSg3yWb5m8KUNISaxntUZcYImLfY/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ts": "={{$node[\"Webhook\"].json.body.timestamp}}",
            "site": "={{$node[\"Webhook\"].json.body.site}}",
            "device": "={{$node[\"Webhook\"].json.body.device}}",
            "billing_period": "={{$node[\"Webhook\"].json.body.billing_period}}",
            "kwh_cycle": "={{$node[\"Webhook\"].json.body.kwh_cycle}}",
            "voltage_v": "={{$node[\"Webhook\"].json.body.voltage_v}}",
            "current_a": "={{$node[\"Webhook\"].json.body.current_a}}",
            "power_w": "={{$node[\"Webhook\"].json.body.power_w}}",
            "frequency_hz": "={{$node[\"Webhook\"].json.body.frequency_hz}}",
            "power_factor": "={{$node[\"Webhook\"].json.body.power_factor}}",
            "kwh_today": "={{$node[\"Webhook\"].json.body.kwh_today}}",
            "row_key": "={{ $node[\"SET | Build row_key + cycle_key\"].json.row_key }}",
            "ts_5m": "={{ $node[\"SET | Build ts_5m\"].json.ts_5m }}",
            "cycle_key": "={{ $node[\"SET | Build row_key + cycle_key\"].json.cycle_key }}",
            "base_cost": "={{ $node[\"Webhook\"].json.body.base_cost }}",
            "service_charge": "={{ $node[\"Webhook\"].json.body.service_charge }}",
            "ft_rate": "={{ $node[\"Webhook\"].json.body.ft_rate }}",
            "ft_cost": "={{ $node[\"Webhook\"].json.body.ft_cost }}",
            "subtotal_before_vat": "={{ $node[\"Webhook\"].json.body.subtotal_before_vat }}",
            "vat_7_percent": "={{ $node[\"Webhook\"].json.body.vat_7_percent }}",
            "total_cost": "={{ $node[\"Webhook\"].json.body.total_cost }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ts",
              "displayName": "ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "site",
              "displayName": "site",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "device",
              "displayName": "device",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "billing_period",
              "displayName": "billing_period",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "kwh_cycle",
              "displayName": "kwh_cycle",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "voltage_v",
              "displayName": "voltage_v",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "current_a",
              "displayName": "current_a",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "power_w",
              "displayName": "power_w",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "frequency_hz",
              "displayName": "frequency_hz",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "power_factor",
              "displayName": "power_factor",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "kwh_today",
              "displayName": "kwh_today",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_key",
              "displayName": "row_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ts_5m",
              "displayName": "ts_5m",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "cycle_key",
              "displayName": "cycle_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "base_cost",
              "displayName": "base_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "service_charge",
              "displayName": "service_charge",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_rate",
              "displayName": "ft_rate",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "ft_cost",
              "displayName": "ft_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "subtotal_before_vat",
              "displayName": "subtotal_before_vat",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "vat_7_percent",
              "displayName": "vat_7_percent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "total_cost",
              "displayName": "total_cost",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        -176,
        -704
      ],
      "id": "b781d658-2a33-4e20-8980-bf49fae5f572",
      "name": "GS | Append Energy RAW (5m)1",
      "credentials": {
        "googleApi": {
          "id": "HjMRmBLbJigs0y41",
          "name": "Google Sheets account-ha-n8n-power-meter"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "SET | Build ts_5m",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET | Build ts_5m": {
      "main": [
        [
          {
            "node": "SET | Build row_key + cycle_key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET | Build row_key + cycle_key": {
      "main": [
        [
          {
            "node": "GS | Find Last Power",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CRON | Daily 00:00": {
      "main": [
        [
          {
            "node": "SET | Build midnight row_key + cycle_key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET | Build midnight row_key + cycle_key": {
      "main": [
        [
          {
            "node": "GS | Lookup RAW @00:00",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS | Lookup RAW @00:00": {
      "main": [
        [
          {
            "node": "CODE | Select Latest RAW",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF | RAW Found?": {
      "main": [
        [
          {
            "node": "SET | Build Cycle Summary Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LOG | No RAW at midnight - Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SET | Build Cycle Summary Payload": {
      "main": [
        [
          {
            "node": "GS | Find Cycle Row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS | Find Cycle Row": {
      "main": [
        [
          {
            "node": "CODE | Merge Find + Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF | Cycle Exists?": {
      "main": [
        [
          {
            "node": "GS | Update Cycle Summary",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "GS | Append Cycle Summary",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CODE | Select Latest RAW": {
      "main": [
        [
          {
            "node": "IF | RAW Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CODE | Merge Find + Payload": {
      "main": [
        [
          {
            "node": "IF | Cycle Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GS | Find Last Power": {
      "main": [
        [
          {
            "node": "CODE | Pick Latest Power",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CODE | Pick Latest Power": {
      "main": [
        [
          {
            "node": "IF | Power Changed?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF | Power Changed?": {
      "main": [
        [
          {
            "node": "GS | Append Energy RAW (5m)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF | New 5m Bucket?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF | New 5m Bucket?": {
      "main": [
        [
          {
            "node": "GS | Update Latest Row",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "LOG | RAW Duplicate - Skipped",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "86a7b006-e023-494e-9ec8-315828c9e39a",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6e8bd4e6dcfe2d257f6d9648f4efaf76882daef04e1402d554d9aae9132bba97"
  },
  "id": "erBJAMkqJcylnANL",
  "tags": []
}